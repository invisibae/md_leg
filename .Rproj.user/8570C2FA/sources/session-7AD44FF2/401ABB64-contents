---
title: "01_multiple_deaths"
author: "Devon Milley"
date: "`r Sys.Date()`"

---
```{r}
#| label: load_data
#| include: false


#############
# Load data #
#############

###
# Load libraries
###
source("../../functions/load_libraries_functions.R")


###
# Load style functions
###
source("../../functions/style_functions.R")

###
# Load data
###
source("../../functions/load_data_functions.R")

###
# Load analysis functions
###

###
# Load settings
### 
# gs4_auth()


```

## List of officers who have been involved in multiple deaths

```{r}
# Count and find the percent of officers involved in other death incidents using the new Harvester field
other_death_incidents <- hc_officer_main %>%
  group_by(additional_death) %>%
  summarise(
    count = n()
  ) %>%
  arrange(desc(count)) %>%
  mutate(
    total = sum(count),
    percent = round((count/total)*100, 1)
  )

# Create a data frame of officers who have been involved in other deaths
officers_other_deaths <- hc_officer_main %>%
  filter(additional_death == "Yes")


###
# Calculate NA values for two target columns
###

na_deaths_i_uof_type <- ap_case_complete |>
  filter(is.na(i_uof_type)) %>%
  nrow()

na_deaths_i_police_actions_after_handcuffed <- ap_case_complete |>
  filter(is.na(i_police_actions_after_handcuffed)) %>%
  nrow()


###
# Write code to produce output here
###

# Create a list of columns you want to hide on load
hidden_columns <- as.numeric(c(5:(ncol(officers_other_deaths)-1)))

# Remove columnDefs if you don't want to hide any columns
officers_other_deaths_table <- officers_other_deaths |> 
  datatable(   
    filter = "top", 
    extensions = c(
      "Buttons"
    ), 
    rownames=FALSE,
    escape=FALSE,
    #    style="bootstrap", 
    class="compact cell-border stripe", 
    width="100%", 
    options = list (
      columnDefs = list(list(visible=FALSE, targets=hidden_columns)
                        ),
      dom = "Blftipr",
      deferRender=TRUE,
      autoWidth=TRUE,
      pageLength = 10,
      buttons = list(
          "colvis",
          "csv",
          list(extend = 'excel', title = NULL)
          )
      )
    )

```

# Summary

There are `r nrow(officers_other_deaths)` officers in the HC Officer Main database that were involved in multiple death incidents.


* **Generated on**: 2022-11-14
* **Generated by**: Stephen Neukam 
* **Peer reviewed by**: Devon Milley
* **Edited by**: [[Editor name]]
* **Last updated**: `r Sys.Date()`
* **Analysis done for**: [[list of AP reporters]]
* **Original AP reporter prompt:** [[Description of prompt]]
* **Modified AP reporter prompt:** [[Updated Description of prompt]]

## Findings

### Officers Involved in Multiple Deaths

There are `r nrow(hc_officer_main)` total officers in the HC Officer Main database. There are `r nrow(officers_other_deaths)` in that database that were involved in more than one death incident. Just over 3% of officers have been involved in more than one death incident.

#### Methodology

We grouped on the `additional_death` column to count the number of officers who had and had not been involved in multiple death incidents in the dataset. We then filtered the `additional_death` column to filter for officers who had been involved in more than one death incident to create a sortable, filterable and searchable table of their information.

#### Caveats

It's possible there are other officers that have been involved in more than one death, but that information hasn't been put into the HC Officer Main. According to our analysis in `other_death_incidents` there are 846 entries in which information about an additional death is 'unspecified' and another 198 entries that appear as 'NA'. That means nearly 94% of the entries in the dataset do not specify 'yes' or 'no'.

### Summary table
```{r}
# Output summary stats
output_formatted_table(other_death_incidents,"Number of officers who have been involved in other death incidents")
```

#### Sortable, Filterable, Searchable Table
```{r}
# output sortable table
officers_other_deaths_table
```




<<<<<<< HEAD

# create a dataframe to count the number of instances of years of experience
hc_officers_years_exp_count <- hc_officers_years_exp %>%
  group_by(grouped_years_exp) %>%
  summarise(
    count = n()
  ) %>%
  arrange(desc(count)) %>%
  mutate(
    total = sum(count),
    percent = round((count/total)*100, 1)
  )

# create a bar chart of officer experience
# years_w_agency_count %>%
#   ggplot() +
#   geom_bar(aes(x=reorder(grouped_years_agency, percent), weight=percent), fill="blue") +
#   coord_flip() +
#   labs(
#     title="Officers' years worked at agency at time of death incident\n",
#     x = "Years at agency\n",
#     y = "\nPercent",
#     caption="Chart by Devon Milley\nSource: Howard Center analysis of police officer personnel database"
#   )
# 
# # Create a table output of findings
# output_formatted_table(years_w_agency_count,"Officers' years worked at agency at time of death incident")


```

## police actions after handcuffed

```{r}
# Pulls the actions_after_handcuffed column from ap_cases_complete and drops cases that have no actions documented
force_buckets <- ap_cases_complete %>% 
  select(i_police_actions_after_handcuffed) %>%
  drop_na(i_police_actions_after_handcuffed)
  
  
force_buckets <- force_buckets %>% 
  mutate(
    clean_police_actions_after_handcuffed = gsub('.{2}$', '', i_police_actions_after_handcuffed),
    clean_police_actions_after_handcuffed = gsub('^.{2}', '', clean_police_actions_after_handcuffed),
    clean_police_actions_after_handcuffed = gsub('[^a-zA-Z/, ]*', '', clean_police_actions_after_handcuffed)
  ) %>%
  select(-i_police_actions_after_handcuffed) %>%
  rename(
    i_police_actions_after_handcuffed = clean_police_actions_after_handcuffed
  )
  

force_split <- cSplit(force_buckets, "i_police_actions_after_handcuffed", ',')

force_split <- data.frame(i_police_actions_after_handcuffed=unlist(force_split))


force_split <- force_split %>%
  group_by(i_police_actions_after_handcuffed) %>%
  summarize(
    count = n()
    ) %>%
  arrange(desc(count)) %>%
  drop_na(i_police_actions_after_handcuffed) %>%
  mutate(total_cases_with_actions_after_handcuffed = nrow(force_buckets)) %>%
  mutate(
    percent = round(count / total_cases_with_actions_after_handcuffed * 100, 1)
  )

```

## joining ap cases and ap officers

```{r}
#left join cases first
ap_complete_cases_and_officers <- ap_cases_complete %>% 
  left_join(ap_officer_master, by=c("d_state_of_death", "d_year_death", "d_last_name","d_first_name")) #i have extra rows and i dont know why

#left join officers first
ap_complete_officers_cases <- ap_officer_master %>% 
  left_join(ap_cases_complete, by=c("d_state_of_death", "d_year_death", "d_last_name","d_first_name"))

#inner join cases first
ap_cases_officers_complete <- ap_cases_complete %>% 
  inner_join(ap_officer_master, by=c("d_state_of_death", "d_year_death", "d_last_name","d_first_name")) #i have fewer rows and i dont know why

```

## Officers who continued to apply force or act dismissively toward the deceased after they were handcuffed

```{r}
#list of officers involved in a case where they continued to apply force or act dimissively to deceased after handcuff
officers_force_after_cuffed <- ap_cases_officers_complete %>% 
  filter(str_detect(i_police_actions_after_handcuffed, "Left deceased face-down") | str_detect(i_police_actions_after_handcuffed, "Bodyweight pressure") | str_detect(i_police_actions_after_handcuffed, "Ignored deceased's complaints of breathing trouble") | str_detect(i_police_actions_after_handcuffed, "Mocked deceased") | str_detect(i_police_actions_after_handcuffed, "Less-lethal weapon") | str_detect(i_police_actions_after_handcuffed, "Physical strikes") | str_detect(i_police_actions_after_handcuffed, "Ignored deceased's complaints of \"Im dying\""))

#list of cases where an officer continued to apply force or act dismissively toward the deceased after they're handcuffed

cases_force_after_cuffed <- ap_cases_complete %>% 
  filter(str_detect(i_police_actions_after_handcuffed, "Left deceased face-down") | str_detect(i_police_actions_after_handcuffed, "Bodyweight pressure") | str_detect(i_police_actions_after_handcuffed, "Ignored deceased's complaints of breathing trouble") | str_detect(i_police_actions_after_handcuffed, "Mocked deceased") | str_detect(i_police_actions_after_handcuffed, "Less-lethal weapon") | str_detect(i_police_actions_after_handcuffed, "Physical strikes") | str_detect(i_police_actions_after_handcuffed, "Ignored deceased's complaints of \"Im dying\""))


```

# Summary

[[Provide short text summary (two sentences) on most significant and interesting findings that will be discussed below.]]


* **Generated on**: 2022-11-15
* **Generated by**: Devon Milley
* **Reviewed by**: [[Editor name]]
* **Last updated**: `r Sys.Date()`
* **Analysis done for**: [[list of AP reporters]]
* **Original AP reporter prompt:** How many officers were involved in multiple restraint/less lethal force deaths? How many were involved in multiple in-custody deaths of any kind? What happened after the first death that allowed the later deaths to take place?
* **Modified AP reporter prompt:** [[Updated Description of prompt]]

## Findings

### Finding Slug 1







=======
>>>>>>> 98038b6be59658aa9dfeba30edc5e7fa3bcc78bd
